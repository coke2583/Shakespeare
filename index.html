<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Shakespeare Reader</title>

  <!-- Inlined favicon to avoid 404 requests -->
  <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/5cAAwMCAKP3IboAAAAASUVORK5CYII="/>

  <style>
    body{
      font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;
      line-height:1.5;
      margin:1rem;
      max-width:45rem;
      background:#000;
      color:#fff;
    }
    select{font-size:1rem;margin:0 0 1rem 0}
    #viewer{white-space:pre-wrap}
    .speech{position:relative;}
    .copy-btn{margin-left:.5rem;font-size:.8rem;}
    #cast h3{
      font-size:1rem;
      margin:0;
    }
  </style>
</head>
<body>
  <h1>Shakespeare Reader</h1>

  <label>Play:
    <select id="playPicker"></select>
  </label>
  <button id="loadBtn">Load</button><br>

  <label>Act:
    <select id="actPicker"></select>
  </label>
  <label>Scene:
    <select id="scenePicker"></select>
  </label>

  <div id="cast"></div>
  <div id="viewer">Loading…</div>
  <button id="nextBtn" style="display:none">Next Scene →</button>

  <script>
  /* ------------ available files ---------------- */
  const plays = [
    "alls-well-that-ends-well_TEIsimple_FolgerShakespeare.xml",
    "a-midsummer-nights-dream_TEIsimple_FolgerShakespeare.xml",
    "antony-and-cleopatra_TEIsimple_FolgerShakespeare.xml",
    "as-you-like-it_TEIsimple_FolgerShakespeare.xml",
    "coriolanus_TEIsimple_FolgerShakespeare.xml",
    "cymbeline_TEIsimple_FolgerShakespeare.xml",
    "hamlet_TEIsimple_FolgerShakespeare.xml",
    "henry-iv-part-1_TEIsimple_FolgerShakespeare.xml",
    "henry-iv-part-2_TEIsimple_FolgerShakespeare.xml",
    "henry-v_TEIsimple_FolgerShakespeare.xml",
    "henry-viii_TEIsimple_FolgerShakespeare.xml",
    "henry-vi-part-1_TEIsimple_FolgerShakespeare.xml",
    "henry-vi-part-2_TEIsimple_FolgerShakespeare.xml",
    "henry-vi-part-3_TEIsimple_FolgerShakespeare.xml",
    "julius-caesar_TEIsimple_FolgerShakespeare.xml",
    "king-john_TEIsimple_FolgerShakespeare.xml",
    "king-lear_TEIsimple_FolgerShakespeare.xml",
    "loves-labors-lost_TEIsimple_FolgerShakespeare.xml",
    "macbeth_TEIsimple_FolgerShakespeare.xml",
    "measure-for-measure_TEIsimple_FolgerShakespeare.xml",
    "much-ado-about-nothing_TEIsimple_FolgerShakespeare.xml",
    "othello_TEIsimple_FolgerShakespeare.xml",
    "pericles_TEIsimple_FolgerShakespeare.xml",
    "richard-ii_TEIsimple_FolgerShakespeare.xml",
    "richard-iii_TEIsimple_FolgerShakespeare.xml",
    "romeo-and-juliet_TEIsimple_FolgerShakespeare.xml",
    "the-comedy-of-errors_TEIsimple_FolgerShakespeare.xml",
    "the-merchant-of-venice_TEIsimple_FolgerShakespeare.xml",
    "the-merry-wives-of-windsor_TEIsimple_FolgerShakespeare.xml",
    "the-taming-of-the-shrew_TEIsimple_FolgerShakespeare.xml",
    "the-tempest_TEIsimple_FolgerShakespeare.xml",
    "the-two-gentlemen-of-verona_TEIsimple_FolgerShakespeare.xml",
    "the-winters-tale_TEIsimple_FolgerShakespeare.xml",
    "timon-of-athens_TEIsimple_FolgerShakespeare.xml",
    "titus-andronicus_TEIsimple_FolgerShakespeare.xml",
    "troilus-and-cressida_TEIsimple_FolgerShakespeare.xml",
    "twelfth-night_TEIsimple_FolgerShakespeare.xml"
  ];

  /* ------------ element handles --------------- */
  const playPicker  = document.getElementById("playPicker");
  const actPicker   = document.getElementById("actPicker");
  const scenePicker = document.getElementById("scenePicker");
  const viewer      = document.getElementById("viewer");
  const castDiv     = document.getElementById("cast");
  const nextBtn     = document.getElementById("nextBtn");

  /* copy-to-clipboard buttons */
  viewer.addEventListener('click',e=>{
    if(e.target.classList.contains('copy-btn')){
      const speech = e.target.closest('.speech').querySelector('.speech-text').innerText;
      navigator.clipboard.writeText(speech).then(()=>{
        e.target.textContent = 'Copied!';
        setTimeout(()=>{e.target.textContent='Copy';},1000);
      });
    }
  });

  const parser      = new DOMParser();
  let   currentDoc  = null;
  let   castHtml    = "";

  /* ----------- populate play list ------------- */
  plays.forEach(f=>{
    const o = document.createElement("option");
    o.value = f;
    o.textContent = f.replace(/_TEIsimple_FolgerShakespeare\.xml$/,"")
                     .replace(/-/g," ")
                     .replace(/\b\w/g,c=>c.toUpperCase());
    playPicker.appendChild(o);
  });

  /* ------------- TEI → HTML ------------------- */
  function teiToHtml(node){
    if(!node) return "";
    let out = "";
    node.childNodes.forEach(ch=>{
      if(ch.nodeType === Node.TEXT_NODE){
        const text = ch.nodeValue;
        if(text.trim()){
          if(/^\s/.test(text)) out += ' ';
          out += text.trim();
          if(/\s$/.test(text)) out += ' ';
        }
      }else{
        switch(ch.nodeName){
          case "w":
          case "pc":
            out += ch.textContent;
            break;
          case "c":
            out += " ";
            break;
          case "lb":
            out += "<br>";
            break;
          case "l":
            out += teiToHtml(ch)+"<br>";
            break;
          case "p":
            out += teiToHtml(ch)+"<br><br>";
            break;
          case "speaker":
            out += "<strong>"+teiToHtml(ch)+"</strong><br>";
            break;
          case "stage":
            out += "<em>"+teiToHtml(ch)+"</em><br>";
            break;
          case "castList":
            out += "<h2>Dramatis Personae</h2><ul>"+teiToHtml(ch)+"</ul><br>";
            break;
          case "castItem": {
            const name = ch.querySelector("role");
            const desc = ch.querySelector("roleDesc");
            const text = (name?teiToHtml(name).trim():"") +
                         (desc?" — "+teiToHtml(desc).trim():"");
            if(text.trim()) out += "<li>"+text+"</li>";
            break;
          }
          case "head":
            if(ch.parentNode && ch.parentNode.nodeName === "castGroup"){
              out += "<li><strong>"+teiToHtml(ch)+"</strong></li>";
            }else{
              out += "<h3>"+teiToHtml(ch)+"</h3>";
            }
            break;
          case "sp":
            out += '<p class="speech"><span class="speech-text">'+teiToHtml(ch)+'</span>'+
                   ' <button class="copy-btn" aria-label="Copy speech">Copy</button></p>';
            break;
          default:
            out += teiToHtml(ch);
        }
      }
    });
    return out;
  }

  /* ----------- populate acts/scenes ----------- */
  function populateActs(xml){
    actPicker.innerHTML = "";
    const acts = xml.querySelectorAll('body div[type="act"]');
    const all = document.createElement("option");
    all.value = "all";
    all.textContent = "All Acts";
    actPicker.appendChild(all);
    acts.forEach((act,i)=>{
      const o = document.createElement("option");
      const head = act.querySelector("head");
      o.value = i;
      o.textContent = head?head.textContent.trim():`Act ${i+1}`;
      actPicker.appendChild(o);
    });
    actPicker.onchange = ()=>{
      const val = actPicker.value === "all" ? null : acts[actPicker.value];
      populateScenes(val);
      displayScene();
    };
    actPicker.value = "all";
    populateScenes(null);
  }

  function populateScenes(act){
    scenePicker.innerHTML = "";
    const scenes = act?act.querySelectorAll('div[type="scene"]'):[];
    const all = document.createElement("option");
    all.value = "all";
    all.textContent = "All Scenes";
    scenePicker.appendChild(all);
    scenes.forEach((sc,i)=>{
      const o = document.createElement("option");
      const head = sc.querySelector("head");
      o.value = i;
      o.textContent = head?head.textContent.trim():`Scene ${i+1}`;
      scenePicker.appendChild(o);
    });
    scenePicker.onchange = displayScene;
    scenePicker.value = "all";
  }

  /* --------------- render view ---------------- */
  function displayScene(){
    if(!currentDoc) return;
    const acts = currentDoc.querySelectorAll('body div[type="act"]');
    let html = "";
    let showCast = false;
    if(actPicker.value === "all"){
      showCast = true;
      acts.forEach(a=>{html += teiToHtml(a);});
    }else{
      const act  = acts[actPicker.value];
      if(scenePicker.value === "all"){
        showCast = actPicker.value === "0"; /* show once for Act 1 when all scenes */
        html += teiToHtml(act);
      }else{
        showCast = actPicker.value === "0" && scenePicker.value === "0";
        const scenes = act.querySelectorAll('div[type="scene"]');
        const scene  = scenes[scenePicker.value];
        html += teiToHtml(scene);
      }
    }

    viewer.innerHTML = html;
    castDiv.innerHTML = showCast ? castHtml : "";

    if(actPicker.value !== "all" && scenePicker.value !== "all" && getNextSceneIndices()){
      nextBtn.style.display = "";
    }else{
      nextBtn.style.display = "none";
    }

    window.scrollTo(0,0);
  }

  function getNextSceneIndices(){
    if(!currentDoc) return null;
    const acts = currentDoc.querySelectorAll('body div[type="act"]');
    let a = Number(actPicker.value);
    let s = Number(scenePicker.value);
    if(isNaN(a) || isNaN(s)) return null;
    let scenes = acts[a].querySelectorAll('div[type="scene"]');
    if(s < scenes.length - 1){
      return {actIndex:a, sceneIndex:s+1};
    }
    for(let nextA=a+1; nextA<acts.length; nextA++){
      const nextScenes = acts[nextA].querySelectorAll('div[type="scene"]');
      if(nextScenes.length){
        return {actIndex:nextA, sceneIndex:0};
      }
    }
    return null;
  }

  function gotoScene(indices){
    const acts = currentDoc.querySelectorAll('body div[type="act"]');
    actPicker.value = indices.actIndex;
    populateScenes(acts[indices.actIndex]);
    scenePicker.value = indices.sceneIndex;
    displayScene();
  }

  /* --------------- main load ------------------ */
  async function loadPlay(file){
    viewer.textContent = "Loading…";
    try{
      const xml = await fetch(`XML/${file}`).then(r=>r.text());
      currentDoc = parser.parseFromString(xml,"application/xml");
      const castList = currentDoc.querySelector("castList");
      castHtml = castList ? teiToHtml(castList) : "";
      populateActs(currentDoc);
      displayScene();
    }catch(e){
      viewer.textContent = "❌ "+e;
      console.error(e);
    }
  }

  /* -------------- wire-up --------------------- */
  document.getElementById("loadBtn")
          .addEventListener("click",()=>loadPlay(playPicker.value));

  nextBtn.addEventListener('click',()=>{
    const next = getNextSceneIndices();
    if(next) gotoScene(next);
  });

  loadPlay(plays[0]);                /* first view */
  </script>
</body>
</html>
